<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Color Test w/ original colors</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="style.css">

</head>
<body>
<div class="container-fluid">
    <div class="row">
        <div class="col center-block text-center">
            <h1 id="title"><b>Potsdam Transportation Company Bus Schedule Manager</b></h1>
            <div id="explanation">
                Press start to begin. If you run out of time before the test is finished, press download to download existing data.
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <div class="buttons">
            <div class="color-box" id="Massena" onclick="endTimer(this)"></div>
            <div class="color-box" id="Canton" onclick="endTimer(this)"></div>
            <div class="color-box" id="Ogdensburg" onclick="endTimer(this)"></div>
            <div class="color-box" id="Watertown" onclick="endTimer(this)"></div>
            <div class="color-box" id="Madrid" onclick="endTimer(this)"></div>
            <div class="color-box" id="Waddington" onclick="endTimer(this)"></div>
        </div>
    </div>
</div>


<div class="container-fluid">
    <div class="row">
        <div class="col col-8">
            <table id="arrival">
                <tr>
                    <th>Click to start the test</th>
                    <th><button id="start-button" onclick="startTest()">Start</button></th>
                </tr>
                <tr>
                    <th>Current round:</th>
                    <th id="round-counter">0</th>
                </tr>
                <tr>
                    <th>Total rounds:</th>
                    <th id="total-rounds"></th>
                </tr>
                <tr>
                    <th>Download data:</th>
                    <th><button id="download-button" onclick="download('data.csv')">Download</button></th>
                </tr>
            </table>
        </div>
        <div class="col">
            <div class="container-current-bus">
                <h4 style="text-align: center;">Current bus at stop</h4>
                <div class="current-bus" id="Massena"></div>
            </div>
        </div>
    </div>
</div>

<script>
    var startTime;
    var endTime;
    var elapsedTime;
    var rounds = 0;
    var maxRounds = 300;
    var done = false;
    var results = [];

    var routes = ["Red", "Brown", "Green", "Yellow", "Blue", "Purple"];
    var randomizedRoutes = ["Red", "Brown", "Green", "Yellow", "Blue", "Purple"];

    var currentBusDiv = document.getElementsByClassName("current-bus")[0];
    var colorBoxDivs = document.getElementsByClassName("color-box");

    var roundConter = document.getElementById("round-counter");
    var totalRoundCounter = document.getElementById("total-rounds");
    var startButton = document.getElementById("start-button")

    // https://stackoverflow.com/questions/2450954/how-to-randomize-shuffle-a-javascript-array
    function shuffleArray(array) {
        for (var i = array.length - 1; i > 0; i--) {
            var j = Math.floor(Math.random() * (i + 1));
            var temp = array[i];
            array[i] = array[j];
            array[j] = temp;
        }
    }

    function randomizeRoutes() {
        shuffleArray(randomizedRoutes);
        for (let i = 0; i < randomizedRoutes.length; i++) {
            this.colorBoxDivs[i].id = randomizedRoutes[i];
        }
    }

    function startTimer() {
        startTime = Date.now();
        randomBus()
        this.roundConter.innerHTML = (rounds + 1);
        randomizeRoutes();

    }

    function startTest() {
        this.startButton.disabled = true;
        this.startButton.innerHTML = "Test in progress";
        for (let i = 0; i < colorBoxDivs.length; i++) {
            this.colorBoxDivs[i].style.pointerEvents = "auto";
        }
        startTimer();
    }

    function download(filename) {
        var csv = [];
        var row = [];

        row.push("1", "2", "3", "4", "5", "6", "answer", "selected", "duration", "is correct");
        csv.push(row.join(","));

        results.forEach((e1) => {
            row = [];
            e1.forEach((e2) => {
                row.push(e2)
            })
            csv.push(row.join(","));
        });

        csv = csv.join("\n")

        var blob = new Blob([csv], {type: "text/csv"});
        var url = window.URL.createObjectURL(blob);
        var a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
    }

    function endTimer(el) {
        if (!done) {
            var answerColor = currentBusDiv.id;
            var selectedColor = el.id;
            var colorList = [];

            endTime = Date.now();
            elapsedTime = endTime - startTime;

            el.parentNode.childNodes.forEach((e) => {
                if (e.id !== undefined) colorList.push(e.id);
            })

            if (answerColor === selectedColor) {
                console.log([colorList, answerColor, selectedColor, elapsedTime, "true"]);
                results.push([colorList, answerColor, selectedColor, elapsedTime, "true"]);
            } else {
                console.log([colorList, answerColor, selectedColor, elapsedTime, "false"]);
                results.push([colorList, answerColor, selectedColor, elapsedTime, "false"]);
            }

            rounds++;
        }

        if (rounds < maxRounds) {
            startTimer()
        } else {
            done = true;
            alert("The test is complete. You will be prompted to download a text file containing the results.")
            download("data.csv");
        }
    }

    function randomBus() {
        r = Math.floor(Math.random() * routes.length);
        newRoute = routes[r]
        this.currentBusDiv.id = newRoute
    }

    this.currentBusDiv.id = "NotStarted"
    this.totalRoundCounter.innerHTML = maxRounds;

    for (let i = 0; i < colorBoxDivs.length; i++) {
        this.colorBoxDivs[i].id = "NotStarted";
        this.colorBoxDivs[i].style.pointerEvents = "none";
    }
</script>

</body>
</html>